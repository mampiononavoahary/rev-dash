
name: Check Vercel Deployment Status

on:
  push:
    branches: [main]

jobs:
  check-vercel-deployment:
    runs-on: ubuntu-latest

    steps:
      - name: Get latest deployment for main branch
        id: get_deployment
        run: |
          echo "üîç Fetching deployment for 'main' branch..."

          for i in {1..10}; do
            DEPLOYMENT=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              "https://api.vercel.com/v6/deployments?projectId=${{ secrets.VERCEL_PROJECT_ID }}&limit=5" \
              | jq -c '.deployments[] | select(.meta.githubCommitRef == "main")' | head -n 1)

            if [ -n "$DEPLOYMENT" ]; then
              DEPLOYMENT_ID=$(echo "$DEPLOYMENT" | jq -r '.uid')
              DEPLOYMENT_URL=$(echo "$DEPLOYMENT" | jq -r '.url')
              echo "‚úÖ Found deployment: $DEPLOYMENT_ID ($DEPLOYMENT_URL)"

              echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV
              echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV
              break
            fi

            echo "‚è≥ Waiting for deployment to appear..."
            sleep 5
          done

          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "‚ùå Failed to find deployment for 'main' branch"
            exit 1
          fi

      - name: Wait for deployment to finish
        run: |
          echo "üîÑ Checking status for deployment ID: $DEPLOYMENT_ID"

          for i in {1..30}; do
            STATUS=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              "https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID" | jq -r '.readyState')

            echo "üîÅ Current status: $STATUS"

            if [ "$STATUS" = "READY" ]; then
              echo "‚úÖ Deployment successful!"
              echo "üîó Link: https://${DEPLOYMENT_URL}"
              exit 0
            elif [ "$STATUS" = "ERROR" ]; then
              echo "‚ùå Deployment failed!"
              exit 1
            fi

            sleep 10
          done

          echo "‚ùå Timeout: Deployment didn't finish in expected time."
          exit 1

