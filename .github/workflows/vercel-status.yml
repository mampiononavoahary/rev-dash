
name: Check Vercel Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  check-deployment:
    name: Check Vercel Deployment Status
    runs-on: ubuntu-latest

    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

    steps:
      - name: üì• R√©cup√©rer le dernier d√©ploiement
        id: get_deployment
        run: |
          DEPLOYMENT=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v6/deployments?projectId=$VERCEL_PROJECT_ID&limit=1")
          
          DEPLOYMENT_ID=$(echo "$DEPLOYMENT" | jq -r '.deployments[0].uid')

          echo "Dernier d√©ploiement ID: $DEPLOYMENT_ID"
          echo "deployment_id=$DEPLOYMENT_ID" >> "$GITHUB_OUTPUT"

      - name: ‚è≥ Attendre que le d√©ploiement soit pr√™t
        run: |
          DEPLOYMENT_ID=${{ steps.get_deployment.outputs.deployment_id }}

          if [ -z "$DEPLOYMENT_ID" ] || [ "$DEPLOYMENT_ID" == "null" ]; then
            echo "::error title=Erreur::Aucun ID de d√©ploiement trouv√©"
            exit 1
          fi

          echo "üîç V√©rification du statut du d√©ploiement ID: $DEPLOYMENT_ID"

          for i in {1..30}; do
            RESPONSE=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID")

            STATUS=$(echo "$RESPONSE" | jq -r '.readyState')
            URL=$(echo "$RESPONSE" | jq -r '.url')
            DOMAIN=$(echo "$RESPONSE" | jq -r '.alias[0] // "non disponible"')

            echo "::notice title=Statut::$STATUS"
            echo "üîÑ Statut actuel: $STATUS"

            if [ "$STATUS" = "READY" ]; then
              echo "‚úÖ D√©ploiement termin√© avec succ√®s!"
              echo "üåê Domaine : https://$DOMAIN"
              echo "::notice title=D√©ploiement termin√©::Domaine: https://$DOMAIN"
              exit 0
            elif [ "$STATUS" = "ERROR" ]; then
              echo "::error title=√âchec du d√©ploiement::Le d√©ploiement a √©chou√© ‚ùå"
              exit 1
            fi

            sleep 10
          done

          echo "::error title=D√©lai d√©pass√©::Le d√©ploiement n'est pas pr√™t apr√®s 5 minutes"
          exit 1

